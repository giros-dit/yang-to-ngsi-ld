# NGSI-LD data models and NGSI-LD client tester for *ietf-interfaces@2018-02-20* YANG model

Tester for the [`Python-based NGSI-LD API client`](https://github.com/giros-dit/python-ngsi-ld-client/tree/1.6.1) compliant with the [NGSI-LD API OpenAPI specification](https://forge.etsi.org/rep/cim/NGSI-LD/-/tree/1.6.1).

To deploy a docker-compose scenario with the [`Orion-LD`](https://github.com/FIWARE/context.Orion-LD) context broker (a reference implementation of NGSI-LD context broker compliant with the  NGSI-LD API specification by [ETSI GS CIM 009 V1.6.1](https://www.etsi.org/deliver/etsi_gs/CIM/001_099/009/01.06.01_60/gs_CIM009v010601p.pdf)), execute the following command:
```bash
$ cd ietf-interfaces-tester
$ docker-compose up
```

In case you are interested in running the scenario in background, use the following command:
```bash
$ cd ietf-interfaces-tester
$ docker-compose up -d
```

Tear the scenario down as follows:
```bash
$ cd ietf-interfaces-tester
$ docker-compose down
```

> **Note:**
>
> In the `.env` file, environment variables are defined and parameterized (i.e., the context broker endpoint and the NGSI-LD context URL).

Within the [/ngsi-ld-models](ngsi-ld-models/) folder there is a Python library called `ngsi_ld_models` derived from the [Pydantic](https://docs.pydantic.dev/latest/) class code generation for the schemas defined in a custom OpenAPI available [here](ngsi-ld-api-ietf-interfaces%402018-02-20-yang-model.yaml). This custom OpenAPI encompass the `NGSI-LD API V1.6.1` with the native NGSI-LD API metamodel schemas and customizable schemas for a NGSI-LD models of [`ietf-intefaces@2018-02-20.yang` YANG model](../../../yang/modules/ietf-interfaces%402018-02-20.yang) used in this NGSI-LD client tester (a sample of JSON payloads for the NGSI-LD Entities of type `Interface` and `Statistics` are available [here](ietf-intefaces-tester/examples/ietf-interfaces/) and the NGSI-LD information model representation is available [here](../../information-models/interfaces-ngsi-ld-schema-if-reduced.png)). The Python code of the `ngsi_ld_models` library derived from the OpenAPI specification is automatically generated by the [OpenAPI Generator](https://openapi-generator.tech) project. To generate the code derived from the particular schemas defined within the OpenAPI, the [OpenAPI Generator Docker image option](https://openapi-generator.tech/docs/installation#docker) has been used with the following command executed from the current folder:
```bash
$ docker run --rm   -v ${PWD}:/openapi-schemas openapitools/openapi-generator-cli generate   -i /openapi-schemas/ngsi-ld-api-ietf-interfaces@2018-02-20-yang-model.yaml -g python --package-name ngsi_ld_models   -o /openapi-schemas/ngsi-ld-models --additional-properties disallowAdditionalPropertiesIfNotPresent=false --global-property models --skip-validate-spec
```

To validate the [`create_entity`](https://github.com/giros-dit/python-ngsi-ld-client/blob/1.6.1/docs/ContextInformationProvisionApi.md#create_entity), [`retrieve_entity`](https://github.com/giros-dit/python-ngsi-ld-client/blob/1.6.1/docs/ContextInformationConsumptionApi.md#retrieve_entity), [`query_entity`](https://github.com/giros-dit/python-ngsi-ld-client/blob/1.6.1/docs/ContextInformationConsumptionApi.md#query_entity), [`update_entity`](https://github.com/giros-dit/python-ngsi-ld-client/blob/1.6.1/docs/ContextInformationProvisionApi.md#update_entity), [`delete_entity`](https://github.com/giros-dit/python-ngsi-ld-client/blob/1.6.1/docs/ContextInformationProvisionApi.md#delete_entity), and [`upsert_batch`](https://github.com/giros-dit/python-ngsi-ld-client/blob/1.6.1/docs/ContextInformationProvisionApi.md#upsert_batch) `CRUD` operations for simple NGSI-LD Entities (e.g., NGSI-LD Entities of type `Interface` and `Statistics` available [here](ietf-intefaces-tester/examples/ietf-interfaces/ietf-interfaces-ngsi-ld-reduced.json)), follow these steps:
1. Download and install `poetry` by following the [official documentacion](https://python-poetry.org/docs/master/#installing-with-the-official-installer).
2. Make sure you have the right Python version for this project (Python>3.9 in this case):
     ```bash
    $ sudo apt-get install python3.9
    ```
3. Install `distutils` package for your specific Python release:
    ```bash
    $ sudo apt-get install python3-distutils
    ```
4. Install `python-is-python3` package (symlinks /usr/bin/python to Python3 as specified in [link 1](https://askubuntu.com/questions/1296790/python-is-python3-package-in-ubuntu-20-04-what-is-it-and-what-does-it-actually) and [link 2](https://stackoverflow.com/questions/61921940/running-poetry-fails-with-usr-bin-env-python-no-such-file-or-directory)):
    ```bash
    $ sudo apt-get install python-is-python3
    ```
5. To build the `ngsi_ld_models` library with the Python-generated classes for the NGSI-LD models related to the `ietf-intefaces@2018-02-20` YANG model, follow these steps:
    - Move to [`/ngsi-ld-models`](ngsi-ld-models/) folder:
        ```bash
        $ cd ngsi-ld-models
        ```
    - Install the dependencies for the `ngsi_ld_models` library with [Poetry](https://python-poetry.org/):
        ```bash
        $ poetry install
        ```
        The `ngsi_ld_models` Python library is now installed and prepared to be used.
6. To play with the  NGSI-LD API `CRUD` operations for the demo NGSI-LD Entity of type `Interface`, first follow these preparation steps: 
    - Move to [`/ietf-interfaces-tester`](ietf-intefaces-tester/) folder:
        ```bash
        $ cd ietf-interfaces-tester
        ```
    - Enable virtual environment for your specific Python release:
        ```bash
        $ poetry env use 3.9
        ```
        > **Note:**
        >
        > If you work with [Visual Studio Code (VSC)](https://code.visualstudio.com/) IDE, it is recommendable to open the `/ietf-interfaces-tester` folder in an independent workspace so that the virtual environment can select the correct Python interpreter and thus recognize the source code well. In VSC you can specify the correct Python interpreter by using the [**Python: Select Interpreter** command](https://code.visualstudio.com/docs/python/environments#_working-with-python-interpreters) from the **Command Palette** (`Ctrl+Shift+P`).
    - Setup the virtual environment with Poetry:
        ```bash
        $ poetry shell
        (ietf-interfaces-tester-py3.9) $ poetry install
        ```
        The virtual environment is now activated and ready to be used.
7. To create a sample NGSI-LD Entity (e.g, NGSI-LD Entity of type `Interface`), run the [ietf-intefaces-tester/create-interface-entity.py](ietf-intefaces-tester/create-interface-entity.py) Python script as follow:
    ```bash
    (ietf-interfaces-tester-py3.9) $ python create-interface-entity.py
    ```
8. To retrieve the previously created NGSI-LD Entity by using its `id` field, run the [etf-intefaces-tester/retrieve-interface-entity.py](ietf-intefaces-tester/retrieve-interface-entity.py) Python script as follow:
    ```bash
    (ietf-interfaces-tester-py3.9) $ python retrieve-interface-entity.py
    ```
9. To query all the NGSI-LD Entities of a particular type (e.g, NGSI-LD Entity of type `Interface`), run the [ietf-intefaces-tester/query-interface-entities.py](ietf-intefaces-tester/query-interface-entities.py) Python script as follow:
    ```bash
    (ietf-interfaces-tester-py3.9) $ python query-interface-entities.py
    ```
10. To update the previously created NGSI-LD Entity by using its `id` field, run the [ietf-intefaces-tester/update-interface-entity.py](ietf-intefaces-tester/update-interface-entity.py) Python script as follow:
    ```bash
    (ietf-interfaces-tester-py3.9) $ python update-interface-entity.py
    ```
11. To delete the previously created NGSI-LD Entity by using its `id` field, run the [ietf-intefaces-tester/delete-interface-entity.py](ietf-intefaces-tester/delete-interface-entity.py) Python script as follow:
    ```bash
    (ietf-interfaces-tester-py3.9) $ python delete-interface-entity.py
    ```
12. To create different NGSI-LD Entities (e.g, NGSI-LD Entities of type `Interface` and `Statistics`) by using its `id` field, run the [ietf-intefaces-tester/upsert-interface-statistics-entities.py](ietf-intefaces-tester/upsert-interface-statistics-entities.py) Python script as follow:
    ```bash
    (ietf-interfaces-tester-py3.9) $ python upsert-interface-statistics-entities.py
    ```
    The resulting JSON payload for the created NGSI-LD Entities of type `Interface` and `Statistics` is available [here](ietf-intefaces-tester/examples/ietf-interfaces/ietf-interfaces-ngsi-ld-reduced.json), and the regarding NGSI-LD information model representation with instantiated values is available [here](../../information-models/interfaces-ngsi-ld-instance-reduced.png)).

In addition, for validating example JSON-LD payloads (e.g., [`Interface`](ietf-intefaces-tester/examples/ietf-interfaces/interface/example-normalized.json) and [`Statistics`](ietf-intefaces-tester/examples/ietf-interfaces/statistics/example-normalized.json) examples) against the autogenerated Python class bindings (e.g., `Interface` Pydantic class available [here](ngsi-ld-models/ngsi_ld_models/models/interface.py) and `Statistics` Pydantic class available [here](ngsi-ld-models/ngsi_ld_models/models/statistics.py)), run the [/ietf-intefaces-tester/tests/test_ietf_interfaces.py](ietf-intefaces-tester/tests/test_ietf_interfaces.py) Python unit test from the `ietf-intefaces-tester` folder as follows:
```bash
$ cd ietf-intefaces-tester
$ poetry shell
(ietf-interfaces-tester-py3.9) $ python tests/test_ietf_interfaces.py
```
